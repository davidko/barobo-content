/*! LinkbotJS 04-09-2014 */
function RobotStatus(){var a=this;this.robots=[],this.list=function(){return a.robots},this.acquire=function(b){var c=a.robots.filter(function(a){return"ready"===a.status}),d={robots:[],registered:a.robots.length,ready:c.length};return d.ready>=b&&(rs=c.slice(0,b),rs.map(function(a){return a.status="acquired",a.status}),d.robots=rs.map(function(a){return a.linkbot}),d.ready-=b),d},this.add=function(b){return a.robots.map(function(a){return a.id}).indexOf(b)<0?a.robots.push({status:"new",id:b}):!1},this.remove=function(b){var c=a.robots.map(function(a){return a.id}).indexOf(b);return c>=0?a.robots.splice(c,1):!1},this.relinquish=function(b){var c=a.robots.map(function(a){return a.id}).indexOf(b._id);return c>=0&&"acquired"===a.robots[c].status?(a.robots[c].status="ready",a.robots[c].status):!1},this.ready=function(b,c){var d=a.robots[b];null!==d&&(d.linkbot=c,d.status="ready")},this.fail=function(b){var c=a.robots[b];null!==c&&(c.status="failed")}}function RobotManager(a){function b(a){if(a){var c=a.getAttribute("id");return c&&/^robomgr\-id\-/.test(c)?a:b(a.parentElement)}return null}function c(a){var b=a.target.getAttribute("id");b&&/^robomgr\-id\-/.test(b)&&(a.dataTransfer.setData("text/html",a.target.innerHTML),a.dataTransfer.effectAllowed="move",source=a.target)}function d(a){a.preventDefault&&a.preventDefault(),a.dataTransfer.dropEffect="move"}function e(a){if(a.stopPropagation&&a.stopPropagation(),source!=a.target){var c=b(a.target);if(!c||null===c)return!0;var d=source.getAttribute("id").replace(/robomgr-id-/,""),e=c.getAttribute("id").replace(/robomgr-id-/,""),f=c.parentElement;c==f.lastChild?(f.removeChild(source),f.insertBefore(source,null)):c==source.nextSibling?(f.removeChild(source),f.insertBefore(source,c.nextSibling)):(f.removeChild(source),f.insertBefore(source,c));for(var g=n.moved,h=0;h<g.length;h++)g[h](d,e);return!1}return!0}function f(a){var b;a.preventDefault(),b=m.element.querySelector("input#robotInput"),m.add(b.value),b.value="",m.connect(),m.redraw()}function g(b){var c,d,e;return b.preventDefault(),e=m.element.querySelector("span"),c=a.querySelector("#robomgr-container"),d=/robomgr-left/.test(e.className),d?(e.className="robomgr-pulloutbtn robomgr-right",c.className="robomgr-container-hidden"):(e.className="robomgr-pulloutbtn robomgr-left",c.className="robomgr-container-open"),b}function h(a){var b=a.target;if(/robomgr-slide-element/.test(b.className)){var c=/robomgr-slide-element-right/.test(b.className);b.className=c?"robomgr-slide-element robomgr-slide-element-left":"robomgr-slide-element robomgr-slide-element-right"}}function i(a,b){a.preventDefault(),m.robots.remove(b);for(var c=n.remove,d=0;d<c.length;d++)c[d](b);m.redraw()}function j(a,b){var f=a.createElement("li"),g=a.createElement("div"),j=a.createElement("span");j.setAttribute("class","robomgr-remove-btn"),j.innerText="Trash";var k=a.createElement("span");k.setAttribute("class","robomgr-beep-btn"),k.innerText="Beep",f.setAttribute("draggable","true"),f.setAttribute("class","robomgr--"+b.status),f.setAttribute("id","robomgr-id-"+b.id),f.appendChild(k),f.appendChild(j),g.setAttribute("class","robomgr-slide-element robomgr-slide-element-left");var l=["",'<span id="robot-id-'+b.id+'-name" class="robomgr-robot-name">Linkbot '+b.id+"</span><br/>",'<span id="robot-id-'+b.id+'-status" class="robomgr-robot-status">'+("failed"==b.status?"offline":b.status)+"</span>"].join("");return g.innerHTML=l,f.appendChild(g),f.addEventListener("dragstart",c),f.addEventListener("dragover",d),f.addEventListener("drop",e),g.addEventListener("click",h),j.addEventListener("click",function(a){i(a,b.id)}),k.addEventListener("click",function(){"failed"!==b.status&&(b.linkbot.buzzerFrequency(500),setTimeout(function(){b.linkbot.buzzerFrequency(0)},250))}),f}function k(a){var b=a.createElement("div");b.setAttribute("id","robomgr-top-navigation");var c=["",'<h1 class="robomgr-logo">Linkbot Labs</h1>','<div class="robomgr-top-nav-info">',' <p class="robomgr-top-nav-breadcrumbs">Lessons // Algebra 1 // Chapter 1</p>',' <h1 class="robomgr-top-nav-title">Example Lesson 1</h1>',"</div>"].join("");return b.innerHTML=c,b}function l(a){var b,c,d;c=a.createElement("div"),c.setAttribute("class","robomgr-container-hidden"),c.setAttribute("id","robomgr-container");var e=["",'<div class="robomgr-pullout">','  <span class="robomgr-pulloutbtn robomgr-right"></span>',"</div>",'<div id="robomgr-container-content">',"  <form>",'    <div id="robotFormContainer">','      <label for="robotInput" id="robotInputLabel" class="sr-only">Linkbot ID</label>','      <input name="robotInput" id="robotInput" type="text" placeholder="Linkbot ID" />','      <button id="robomgr-add">Add</button>',"    </div>",'  </form><ol id="robomgr-robot-list"></ol>',"</div>"].join("");return c.innerHTML=e,b=c.querySelector("button"),d=c.querySelector(".robomgr-pullout"),b.addEventListener("click",f),d.addEventListener("click",g),c}var m=this,n={add:[],remove:[],moved:[]};this.robots=new RobotStatus,this.element=l(a),this.topNav=k(a),this.acquire=function(a){var b=m.robots.acquire(a);return m.redraw(),b},this.relinquish=function(a){a.disconnect(),m.robots.relinquish(a),m.redraw()},this.add=function(){var a=1<=arguments.length?[].slice.call(arguments,0):[],b=n.add;a.map(function(a){m.robots.add(a);for(var c=0;c<b.length;c++)b[c](a)})},this.redraw=function(){var a=m.element.ownerDocument,b=a.createElement("ol");b.setAttribute("id","robomgr-robot-list");for(var c=m.robots.list(),d=0;d<c.length;d++){var e=c[d];b.appendChild(j(a,e))}var f=m.element.querySelector("ol#robomgr-robot-list");f.parentElement.replaceChild(b,f)},this.connect=function(){for(var a=m.robots.list(),b=[],c=0;c<a.length;c++){var d=a[c];"new"===d.status?(bot=new Linkbot(d.id),b.push(null!==bot._id?m.robots.ready(c,bot):m.robots.fail(c))):b.push(void 0)}return b},this.registerEvent=function(a,b){var c=n[a];c&&c.push(b)},this.unregisterEvent=function(a,b){var c=n[a];c&&c.pop(b)}}function Linkbot(a){function b(a,b,c,d){return null===d&&(d={}),function(e,f,g){return 1===g&&a._id===e&&b===f?c(a,d,{button:f}):void 0}}function c(a,b,c,d){return null===d&&(d={}),function(e,f,g){var h;return a._id===e&&b===f?(h=g-a._wheelPositions[b-1],a._wheelPositions[b-1]=g,c(a,d,{triggerWheel:b,position:g,difference:h})):void 0}}var d=this;if(d._id=a,err=baroboBridge.connectRobot(a),0>err)return void(d._id=null);for(var e=1;3>=e;e++)baroboBridge.setMotorEventThreshold(d._id,e,1e10);if(d._wheelPositions=baroboBridge.getMotorAngles(d._id),d._firmwareVersion=baroboBridge.firmwareVersion(d._id),!baroboBridge.mock){var f=baroboBridge.availableFirmwareVersions();f.indexOf(d._firmwareVersion)<0&&(idAsURI=encodeURIComponent(d._id),baroboBridge.stop(d._id),document.location="../LinkbotUpdate/index.html?badRobot="+idAsURI)}this._wheelRadius=1.75,this.color=function(a,b,c){baroboBridge.setLEDColor(d._id,a,b,c)},this.angularSpeed=function(a,b,c){return null===b&&(b=a),null===c&&(c=a),baroboBridge.angularSpeed(d._id,a,b,c)},this.move=function(a,b,c){return baroboBridge.move(d._id,a,b,c)},this.moveTo=function(a,b,c){return baroboBridge.moveTo(d._id,a,b,c)},this.wheelPositions=function(){return d._wheelPositions=baroboBridge.getMotorAngles(d._id),d._wheelPositions},this.stop=function(){return baroboBridge.stop(d._id)},this.buzzerFrequency=function(a){return baroboBridge.buzzerFrequency(d._id,a)},this.disconnect=function(){return d.stop(),d._id=null,d._id},this.register=function(a){var e,f,g,h,i,j,k,l;if(null!==a.button){i=a.button;for(e in i)__hasProp.call(i,e)&&(f=i[e],g=b(d,parseInt(e),f.callback,f.data),baroboBridge.buttonChanged.connect(g),baroboBridge.enableButtonSignals(d._id))}if(null!==a.wheel){j=a.wheel,k=[];for(l in j)__hasProp.call(j,l)&&(f=j[l],h=parseInt(l),g=c(d,h,f.callback,f.data),baroboBridge.setMotorEventThreshold(d._id,h,f.distance),baroboBridge.motorChanged.connect(g),k.push(baroboBridge.enableMotorSignals(d._id)));return k}},this.unregister=function(){return baroboBridge.motorChanged.disconnect(),baroboBridge.disableMotorSignals(d._id),baroboBridge.buttonChanged.disconnect(),baroboBridge.disableButtonSignals(d._id)}}function Storage(a){var b=a?a:{DBNAME:"robotsdb",DBVER:1,DBDESC:"Robots Database, used for persistance",TABLE:"robots"},c=openDatabase(b.DBNAME,b.DBVER,b.DBDESC,b.DBSIZE);c.transaction(function(a){a.executeSql("CREATE TABLE IF NOT EXISTS "+b.TABLE+" (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT unique not null, status INTEGER not null, rorder INTEGER not null)",[],function(){},function(a,b){console.log(b)})}),this.remove=function(a,d){c.transaction(function(c){c.executeSql("DELETE FROM "+b.TABLE+" WHERE name = ?",[a],function(){d&&d(!0)},function(a,b){d&&d(!1,b)})})},this.add=function(a,d,e){c.transaction(function(c){c.executeSql("SELECT COUNT(*) AS c FROM "+b.TABLE,[],function(c,f){c.executeSql("INSERT INTO "+b.TABLE+" (name, status, rorder) values (?,?,?)",[a,d,f.rows.item(0).c],function(){e&&e(!0)},function(a,b){e&&e(!1,b)})},function(a,b){e&&e(!1,b)})})},this.getAll=function(a){c.transaction(function(c){c.executeSql("SELECT * FROM "+b.TABLE+" ORDER BY rorder",[],function(b,c){for(var d=c.rows,e=[],f=0;f<c.rows.length;f++)e.push({id:d.item(f).id,name:d.item(f).name,status:d.item(f).status,order:d.item(f).rorder});a&&a(e)},function(b,c){a&&a([],c)})})},this.updateOrder=function(a){c.transaction(function(c){c.executeSql("SELECT id FROM "+b.TABLE+" ORDER BY rorder",[],function(c,d){for(var e=function(){},f=function(){a&&a(!1,results)},g=0;g<d.rows.length;g++)c.executeSql("UPDATE "+b.TABLE+" SET rorder = ? WHERE id = ?",[g,d.rows.item(g).id],e,f);a&&a(!0)},function(){a&&a(!1,results)})})},this.printRows=function(){c.transaction(function(a){a.executeSql("SELECT * FROM "+b.TABLE+" ORDER BY rorder",[],function(a,b){for(var c=b.rows,d=0;d<b.rows.length;d++)console.log("ID:"+c.item(d).id+", NAME:"+c.item(d).name+", STATUS:"+c.item(d).status+", ORDER:"+c.item(d).rorder)},function(a,b){console.log(b)})})},this.changePosition=function(a,d,e){a!==d&&c.transaction(function(c){var f=a,g=d;a>d&&(f=d,g=a),c.executeSql("SELECT * from "+b.TABLE+" WHERE rorder BETWEEN ? and ? ORDER BY rorder",[f,g],function(c,f){var g=0,h=-1,i=f.rows;a>d&&(h=1);var j=function(a,b){e&&e(!0,b)},k=function(){e&&e(!1,results)};for(g=0;g<f.rows.length;g++){var l=i.item(g).rorder+h,m=i.item(g).id;i.item(g).rorder==a&&(l=d),c.executeSql("UPDATE "+b.TABLE+" SET rorder = ? WHERE id = ?",[l,m],j,k)}e&&e(!0)},function(a,b){e&&e(!1,b)})})}}baroboBridge=function(a){var b,c,d,e;if(null!==a.baroboBridge)return a.baroboBridge;methods=["angularSpeed","availableFirmwareVersions","buttonChanged","connectRobot","disconnectRobot","enableButtonSignals","enableMotorSignals","disableButtonSignals","disableMotorSignals","firmwareVersion","getMotorAngles","scan","setMotorEventThreshold","stop"],signals=["motorChanged","buttonChanged"],obj={mock:!0};var f=function(){};for(b=0,d=methods.length;d>b;b++)k=methods[b],obj[k]=f;for(c=0,e=signals.length;e>c;c++)k=signals[c],obj[k]={connect:f,disconnect:f};return obj}(this);var Linkbots=function(a,b){function c(a,b){g.getAll(function(c){srcOrder=-1,destOrder=-1;for(var d=0;d<c.length&&(c[d].name===a?srcOrder=c[d].order:c[d].name===b&&(destOrder=c[d].order),!(destOrder>=0&&srcOrder>=0));d++);destOrder>=0&&srcOrder>=0&&g.changePosition(srcOrder,destOrder,function(a){if(a===!0){var b=f.robots.robots.splice(srcOrder,1);f.robots.robots.splice(destOrder,0,b[0])}})})}function d(a){g.add(a,0)}function e(a){g.remove(a,function(a){a&&g.updateOrder()})}var f=new RobotManager(b),g=new Storage;return g.getAll(function(a){for(var b=0;b<a.length;b++)f.add(a[b].name);f.connect(),f.redraw()}),f.registerEvent("moved",c),f.registerEvent("add",d),f.registerEvent("remove",e),a.scan=function(){return baroboBridge.scan()},a.managerElement=function(){return f.element},a.topNavElement=function(){return f.topNav},a.acquire=function(a){return f.acquire(a)},a.relinquish=function(a){return f.relinquish(a)},a.managerAdd=function(){var a=1<=arguments.length?[].slice.call(arguments,0):[];return f.add.apply(f,a)},a.managerRedraw=function(){return f.redraw()},a.managerConnect=function(){return f.connect()},a.storage=g,a}(Linkbots||{},document);